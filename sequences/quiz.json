{
  "name": "quiz",
  "display_name": "Викторина",
  "description": "Пока не работает. Позволяет проводить викторины.",
  "version": [0,0,0,0],
  "triggers": [
    {
      "type": "text_exact",
      "params": ["бот это кто"],
      "subseq": "main"
    },
    {
      "type": "text_exact",
      "params": ["бот кто это"],
      "subseq": "main"
    },
    {
      "type": "text_prefix",
      "params": ["викторина редактировать"],
      "subseq": "quiz_edit",
      "raw": true
    },
    {
      "type": "text_exact",
      "params": ["викторина завершить работу"],
      "subseq": "quiz_stop_edit"
    }
  ],
  "timers": [
    ["quiz_get_plan",5]
  ],
  "subseqs": {
    "quiz_end_edit": [
      {
        "action": "call",
        "params": ["require_edit_session"]
      },
      {
        "action": "quiz_finish_edit",
        "params": ["quiz_id","nobodycares"]
      },
      {
        "action": "emit_text",
        "params": ["done_editing", -1]
      }
    ],
    "require_edit_session": [
      {
        "action": "quiz_find_session",
        "params": ["session_count","quiz_id"]
      },
      {
        "action": "if_eq",
        "params": ["*session_count",1,"","must_have_session"]
      }
    ],
    "must_have_session": [
      {
        "action": "emit_text",
        "params": ["must_have_session",-1]
      }

    ],
    "quiz_edit": [
      {
        "action": "get_match",
        "params": ["quiz_id"]
      },
      {
        "action": "quiz_find_session",
        "params": ["session_count","session_id"]
      },
      {
        "action": "if_eq",
        "params": ["*session_count",0,"begin_editing",""]
      },
      {
        "action": "if_eq",
        "params": ["*session_count",1,"check_if_current_is_same",""]
      },
      {
        "action": "gosub",
        "params": ["editing_in_progress"]
      }
    ],
    "check_if_current_is_same": [
      {
        "action": "if_eq",
        "params": ["*session_id","*quiz_id","","editing_in_progress"]
      },
      {
        "action": "emit_text",
        "params": ["already_editing",-1]
      }
    ],
    "editing_in_progress": [
      {
        "action": "emit_text",
        "params": ["session_in_progress",-1]
      }
    ],
    "begin_editing": [
      {
        "action": "quiz_fetch_quiz",
        "params": ["*quiz_id","quiz"]
      },
      {
        "action": "if_eq",
        "params": ["*quiz", null, "quiz_not_found",""]
      },
      {
        "action": "quiz_begin_edit",
        "params": ["*quiz_id", "session_started"]
      },
      {
        "action": "emit_text",
        "params": ["session_started",-1]
      }
    ],
    "quiz_get_plan": [
      {
        "action": "quiz_get_plan",
        "params": ["quiz_plan"]
      },
      {
        "action": "gosub",
        "params": ["quiz_count_plan"]
      }
    ],
    "quiz_count_plan": [
      {
        "action": "count",
        "params": ["quiz_plan","quiz_plan_count"]
      },
      {
        "action": "if_eq",
        "params": [0,"*quiz_plan_count","quiz_no_more_plan","quiz_tick"]
      }
    ],
    "quiz_tick": [
      {
        "action": "quiz_do_plan",
        "params": ["quiz_plan","quiz_next", "plan_param","quiz_session"]
      },
      {
        "action": "obj_read",
        "params": ["quiz_session","id","quiz_session_id"]
      },
      {
        "action": "concat",
        "params": ["quiz_plan_","*quiz_next","quiz_next"]
      },
      {
        "action": "gosub",
        "params": ["*quiz_next"]
      }
    ],
    "quiz_plan_start_animation": [
      {
        "action": "obj_read",
        "params": ["quiz_session","start_message","quiz_msg_id"]
      },
      {
        "action": "concat",
        "params": ["start_msg_frame_","*plan_param","next_msg"]
      },
      {
        "action": "edit_msg",
        "params": ["*quiz_msg_id","*next_msg"]
      },
      {
        "action": "gosub",
        "params": ["quiz_count_plan"]
      }
    ],
    "quiz_plan_quiz_finish": [
      {
        "action": "quiz_finish",
        "params": ["*quiz_session_id","quiz_results"]
      },
      {
        "action": "fmt_list",
        "params": ["quiz_results","winner_line","quiz_board_list"]
      },
      {
        "action": "emit_text",
        "params": ["finish_board"]
      },
      {
        "action": "gosub",
        "params": ["quiz_count_plan"]
      }
    ],
    "quiz_plan_question": [
      {
        "action": "obj_read",
        "params": ["quiz_session","quiz_id","quiz_id"]
      },
      {
        "action": "quiz_fetch_question",
        "params": ["*quiz_id","*plan_param","question"]
      },
      {
        "action": "quiz_fetch_quiz",
        "params": ["*quiz_id","quiz"]
      },
      {
        "action": "obj_read",
        "params": ["question","choices","choices"]
      },
      {
        "action": "obj_read",
        "params": ["question","text","text"]
      },
      {
        "action": "obj_read",
        "params": ["question","correct_answer","correct"]
      },
      {
        "action": "obj_read",
        "params": ["question","attachment","question_extra"]
      },
      {
        "action": "obj_read",
        "params": ["quiz","question_time","timer"]
      },
      {
        "action": "emit_poll",
        "params": [
          "*text",
          "choices",
          "*correct",
          "*timer",
          "quiz",
          "",
          "poll_id"
        ]
      },
      {
        "action": "quiz_register_poll",
        "params": ["*quiz_session_id","*poll_id","*plan_param"]
      },
      {
        "action": "emit_saved_message",
        "params": ["*question_extra","*timer"]
      },
      {
        "action": "gosub",
        "params": ["quiz_count_plan"]
      }
    ],
    "self": [
      {
        "action": "emit_text",
        "params": ["self",-1]
      }
    ]
  },
  "stringpools": {
    "ok": ["Пользователь {whois_usernick}\naka {usernicks}\nid {userid}\nпепяка: {userrep}{medals}\nпоследнее действие: {recent} назад\nпервое сообщение: {joindate}\n{isreturner}{quotes}\n    "],
    "session_in_progress": ["Невозможно начать \\- уже редактируются другие викторины\\."],
    "session_started": ["Отлично\\, начинаем редактировать \\\"{quiz.title}\\\" \\."],
    "already_editing": ["Уже и так редактируется эта викторина\\."],
    "must_have_session": ["Необходимо выбрать викторину для редактирования\\."],
    "done_editing": ["Редактирование завершено\\."]
  }
}